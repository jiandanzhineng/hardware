name: Build Firmware for All Device Types

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device_config:
          - name: "TD01"
            config: "CONFIG_DEVICE_TD01=y"
          - name: "DIANJI"
            config: "CONFIG_DEVICE_DIANJI=y"
          - name: "QTZ"
            config: "CONFIG_DEVICE_QTZ=y"
          - name: "ZIDONGSUO"
            config: "CONFIG_DEVICE_ZIDONGSUO=y"
          - name: "PJ01"
            config: "CONFIG_DEVICE_PJ01=y"
          - name: "QIYA"
            config: "CONFIG_DEVICE_QIYA=y"
          - name: "DZC01"
            config: "CONFIG_DEVICE_DZC01=y"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Configure device type
      run: |
        # 合并默认配置 (包含分区表配置)
        cat sdkconfig.defaults sdkconfig.defaults.esp32c3 > sdkconfig
        
        # 启用当前设备类型
        echo "${{ matrix.device_config.config }}" >> sdkconfig
        
        # 显示当前配置
        echo "Current device configuration:"
        grep -E "CONFIG_DEVICE_(TD01|DIANJI|QTZ|ZIDONGSUO|PJ01|QIYA|DZC01)" sdkconfig || true

    - name: ESP-IDF Build and Merge
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.2.3
        target: esp32c3
        path: '.'
        command: >
          idf.py build && 
          cd build && 
          esptool.py --chip esp32c3 merge_bin -o blufi_demo_${{ matrix.device_config.name }}_${{ github.ref_name }}_merged.bin @flash_args && 
          mv blufi_demo.bin blufi_demo_${{ matrix.device_config.name }}_${{ github.ref_name }}.bin

    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.device_config.name }}
        path: |
          build/blufi_demo_${{ matrix.device_config.name }}_${{ github.ref_name }}_merged.bin
          build/blufi_demo_${{ matrix.device_config.name }}_${{ github.ref_name }}.bin
          build/bootloader/bootloader.bin
          build/partition_table/partition-table.bin
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: firmware-files

    - name: List downloaded files
      run: |
        echo "Downloaded artifact structure:"
        find firmware-files -type f -name "*.bin" | head -20

    - name: Create release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          firmware-files/firmware-*/blufi_demo_*.bin
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload firmware summary
      run: |
        echo "## Firmware Build Summary" > firmware_summary.md
        echo "" >> firmware_summary.md
        echo "Built firmware for the following device types:" >> firmware_summary.md
        echo "" >> firmware_summary.md
        for device in TD01 DIANJI QTZ ZIDONGSUO PJ01 QIYA DZC01; do
          for file in firmware-files/firmware-${device}/blufi_demo_*.bin; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              size=$(stat -c%s "$file" 2>/dev/null || echo "Unknown")
              echo "- **${device}**: ${filename} (${size} bytes)" >> firmware_summary.md
            fi
          done
        done
        
        cat firmware_summary.md