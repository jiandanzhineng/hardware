# IoT虚拟设备GUI控制器使用说明

## 概述

本GUI控制器基于 `virtual_devices.py` 中的虚拟设备类，提供了一个直观的图形界面来创建、控制和监控各种IoT虚拟设备。通过GUI界面，您可以轻松地模拟设备行为，测试MQTT通信，并观察设备状态变化。

## 支持的设备类型

### 1. TD01设备 - 单路调光插座
- **属性控制**：
  - `power`: 功率值 (0-255，PWM占空比)
  - `sleep_time`: 休眠时间
  - `battery`: 电池电量（只读）
- **动作模拟**：
  - 模拟按键点击 (`key_boot_clicked`)

### 2. DIANJI设备 - 电击设备
- **属性控制**：
  - `voltage`: 目标电压
  - `delay`: 延时设置
  - `shock`: 电击开关 (0=关闭, 1=开启)
  - `sleep_time`: 休眠时间
  - `battery`: 电池电量（只读）
- **特殊功能**：
  - 自动电压控制（模拟PID控制）
  - 电击状态监控

### 3. ZIDONGSUO设备 - 自动锁设备
- **属性控制**：
  - `open`: 锁状态 (0=关闭, 1=打开)
  - `sleep_time`: 休眠时间
  - `battery`: 电池电量（只读）
- **动作模拟**：
  - 模拟按键点击 (`key_clicked`)
- **状态反馈**：
  - 锁关闭：舵机角度180°，LED开启
  - 锁打开：舵机角度0°，LED关闭

### 4. QTZ设备 - VL6180X激光距离传感器 + 双按钮
- **属性控制**：
  - `distance`: 当前距离（只读，mm）
  - `report_delay_ms`: 上报间隔
  - `low_band`: 低阈值
  - `high_band`: 高阈值
  - `button0`: 按钮0状态（只读）
  - `button1`: 按钮1状态（只读）
  - `sleep_time`: 休眠时间
  - `battery`: 电池电量（只读）
- **动作模拟**：
  - 按钮0/1按下模拟
  - 距离值手动设置
- **自动功能**：
  - 距离阈值触发检测
  - 传感器噪声模拟
  - 滞回防抖动

## 安装和运行

### 1. 环境准备
```bash
# 安装依赖
pip install -r requirements.txt

# 确保MQTT代理运行（如mosquitto）
# Windows: 下载并安装mosquitto
# Linux: sudo apt-get install mosquitto mosquitto-clients
# macOS: brew install mosquitto
```

### 2. 启动GUI控制器
```bash
python device_gui_controller.py
```

## 界面功能说明

### 主界面布局

```
┌─────────────────────────────────────────────────────────────────┐
│ 设备控制区域                                                      │
│ [创建TD01] [创建电击] [创建自动锁] [创建QTZ] | [启动所有] [停止所有] │
├─────────────────────────────────┬───────────────────────────────┤
│ 设备列表                         │ 系统日志                       │
│                                │                               │
│ ┌─────────────────────────────┐ │ ┌───────────────────────────┐ │
│ │ TD01 - td01001aabbcc        │ │ │ 2024-01-01 12:00:00 -     │ │
│ │ [启动] [停止]      [删除]    │ │ │ INFO - 创建了新设备...      │ │
│ │ ─────────────────────────── │ │ │ 2024-01-01 12:00:01 -     │ │
│ │ 设备属性:                   │ │ │ INFO - 设备已启动...       │ │
│ │ power: [255] [输入框] [设置] │ │ │ ...                       │ │
│ │ battery: [95]              │ │ │                           │ │
│ │ ─────────────────────────── │ │ │                           │ │
│ │ 设备动作:                   │ │ │                           │ │
│ │ [模拟按键点击]              │ │ │                           │ │
│ └─────────────────────────────┘ │ │ [清空日志] [保存日志]      │ │
│                                │ └───────────────────────────┘ │
└─────────────────────────────────┴───────────────────────────────┘
```

### 功能区域详解

#### 1. 设备控制区域（顶部）
- **设备创建按钮**：点击创建对应类型的虚拟设备
- **全局控制**：一键启动或停止所有设备

#### 2. 设备列表区域（左侧）
每个设备都有独立的控制面板：

- **设备标题**：显示设备类型和ID
- **状态控制**：
  - `启动`：启动设备MQTT连接和后台任务
  - `停止`：停止设备运行
  - `删除`：移除设备（会先自动停止）
  - `状态指示器`：显示当前运行状态

- **设备属性**：
  - 只读属性：仅显示当前值
  - 可写属性：提供输入框和设置按钮
  - 布尔属性：提供切换按钮

- **设备动作**：
  - 设备特定的动作按钮
  - 模拟用户交互（如按键、距离变化等）

#### 3. 系统日志区域（右侧）
- **实时日志显示**：显示所有设备的运行日志
- **日志控制**：
  - `清空日志`：清除当前显示的日志
  - `保存日志`：将日志保存到文件

## 使用流程示例

### 基本使用流程

1. **启动应用**
   ```bash
   python device_gui_controller.py
   ```

2. **创建设备**
   - 点击对应的设备创建按钮
   - 系统自动分配设备ID
   - 设备控制面板出现在设备列表中

3. **启动设备**
   - 点击设备的"启动"按钮
   - 观察状态指示器变为"运行中"
   - 查看日志确认MQTT连接成功

4. **控制设备**
   - 修改可写属性值
   - 点击动作按钮模拟用户交互
   - 观察日志中的设备响应

5. **监控状态**
   - 观察属性值的实时更新
   - 查看设备自动行为（如电池消耗、距离变化等）

### 高级使用场景

#### 场景1：测试TD01调光功能
1. 创建TD01设备并启动
2. 在power属性中输入不同的值（0-255）
3. 点击"设置"按钮
4. 观察日志中的PWM控制信息
5. 点击"模拟按键点击"测试按键响应

#### 场景2：测试电击设备安全机制
1. 创建DIANJI设备并启动
2. 设置目标电压值
3. 观察电压逐渐调整过程
4. 切换shock开关，观察安全警告
5. 调整delay参数测试延时功能

#### 场景3：测试QTZ距离传感器
1. 创建QTZ设备并启动
2. 设置low_band和high_band阈值
3. 手动设置不同的距离值
4. 观察阈值触发事件
5. 测试按钮模拟功能

#### 场景4：多设备协同测试
1. 创建多个不同类型的设备
2. 使用"启动所有设备"批量启动
3. 观察各设备的独立运行状态
4. 测试设备间的MQTT通信

## MQTT通信说明

### 主题结构
- **发布主题**：`/dpub/{device_id}`
- **订阅主题**：`/drecv/{device_id}`
- **广播主题**：`/all`

### 消息格式
```json
{
  "method": "report|set|get|update|action",
  "msg_id": 123,
  "key": "property_name",
  "value": "property_value",
  "action": "action_name"
}
```

### 常用消息类型
- **属性上报**：`{"method": "report", "power": 128, "battery": 95}`
- **属性设置**：`{"method": "set", "key": "power", "value": 200}`
- **动作触发**：`{"method": "action", "action": "key_clicked"}`

## 故障排除

### 常见问题

1. **设备无法启动**
   - 检查MQTT代理是否运行
   - 确认网络连接正常
   - 查看日志中的错误信息

2. **属性设置失败**
   - 确认输入值的格式正确
   - 检查属性是否为可写属性
   - 查看设备是否处于运行状态

3. **GUI响应缓慢**
   - 减少同时运行的设备数量
   - 清空日志释放内存
   - 检查系统资源使用情况

4. **日志显示异常**
   - 重启应用程序
   - 检查日志文件权限
   - 确认日志级别设置

### 调试技巧

1. **使用MQTT客户端工具**
   ```bash
   # 订阅所有消息
   mosquitto_sub -t "/dpub/+"
   
   # 发送测试消息
   mosquitto_pub -t "/drecv/td01001aabbcc" -m '{"method":"set","key":"power","value":128}'
   ```

2. **查看详细日志**
   - 在代码中调整日志级别为DEBUG
   - 保存日志文件进行分析

3. **网络连接测试**
   ```bash
   # 测试MQTT代理连接
   telnet localhost 1883
   ```

## 扩展开发

### 添加新设备类型

1. 在 `virtual_devices.py` 中创建新的设备类
2. 在 `device_gui_controller.py` 的 `create_device` 方法中添加对应的创建逻辑
3. 在 `create_device_frame` 方法中添加设备特定的GUI组件

### 自定义GUI组件

可以根据需要添加：
- 图表显示（使用matplotlib）
- 图像显示（使用PIL）
- 更复杂的控制组件
- 设备状态可视化

### 集成外部工具

- MQTT监控工具
- 数据库记录
- Web界面
- 远程控制API

## 技术架构

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   GUI控制器      │    │   虚拟设备实例    │    │   MQTT代理       │
│                │    │                 │    │                │
│ ┌─────────────┐ │    │ ┌─────────────┐  │    │ ┌─────────────┐ │
│ │ 设备管理器   │◄┼────┤ │ TD01Device  │  │    │ │ mosquitto   │ │
│ └─────────────┘ │    │ └─────────────┘  │    │ └─────────────┘ │
│ ┌─────────────┐ │    │ ┌─────────────┐  │    │                │
│ │ 属性控制器   │◄┼────┤ │ DianjiDevice│  │◄───┤                │
│ └─────────────┘ │    │ └─────────────┘  │    │                │
│ ┌─────────────┐ │    │ ┌─────────────┐  │    │                │
│ │ 日志显示器   │◄┼────┤ │ QTZDevice   │  │    │                │
│ └─────────────┘ │    │ └─────────────┘  │    │                │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## 许可证

本项目遵循与主项目相同的许可证。

---

**注意**：使用前请确保MQTT代理正常运行，建议使用mosquitto作为MQTT代理。如有问题，请查看日志输出或联系开发团队。